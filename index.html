<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”å­”è®¡ç®—å™¨</title>
    
    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4285f4">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="ä¸“ä¸šçš„äº”å­”è®¡ç®—å·¥å…·ï¼Œæ”¯æŒå¤šç§æ¨¡æ¿å’Œç»„åˆè®¡ç®—">
    
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
            position: relative;
            background: #f9f9f9;
            min-height: 100vh;
        }
        .calculator {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h2 {
            color: #4285f4;
            margin-top: 0;
            font-size: 1.5em;
        }
        .input-section {
            background: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .input-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
            font-size: 0.9em;
            min-height: 44px; /* è§¦æ‘¸å‹å¥½ */
        }
        .btn-red {
            background: #ea4335;
        }
        .btn-green {
            background: #0f9d58;
        }
        .btn-purple {
            background: #9c27b0;
        }
        .btn-orange {
            background: #ff9800;
        }
        #points-container {
            margin: 10px 0;
        }
        .point-item {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: move;
        }
        .point-item.dragging {
            opacity: 0.5;
            background: #d0d0d0;
        }
        .point-item input {
            flex: 1;
            min-width: 100px;
        }
        .point-item button {
            flex: 0 0 auto;
            width: auto;
            padding: 8px 12px;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .export-buttons button {
            flex: 1;
            min-width: 120px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-break: break-word;
        }
        th {
            background-color: #f2f2f2;
        }
        
        /* ç”»å¸ƒæ ·å¼ */
        canvas {
            margin-top: 15px;
            border: 1px solid #ddd;
            width: 100%;
            height: auto;
            max-height: 400px;
            display: block;
            background: white;
        }
        
        .toggle-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .toggle-btn {
            flex: 1;
        }
        
        /* æ¨¡æ¿é¢æ¿æ ·å¼ */
        .template-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            overflow: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        .template-panel.collapsed {
            transform: translateX(420px);
            opacity: 0;
        }
        .template-header {
            background: #4285f4;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .template-header h3 {
            margin: 0;
            font-size: 1.1em;
        }
        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 24px;
            height: 18px;
            cursor: pointer;
        }
        .hamburger span {
            display: block;
            height: 3px;
            width: 100%;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .template-content {
            padding: 15px;
        }
        .template-group {
            margin-bottom: 20px;
        }
        .template-group h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .template-buttons button {
            flex: 1;
            min-width: 140px;
            padding: 8px 10px;
            font-size: 0.85em;
        }
        
        /* å¤šæ¨¡æ¿ç»„åˆæ ·å¼ */
        .multi-template-combination {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .template-select-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .template-select-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .template-select-row button {
            flex: 0 0 auto;
            width: auto;
            padding: 8px 12px;
        }
        .selected-templates {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
        }
        .selected-template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        .selected-template-item:last-child {
            border-bottom: none;
        }
        .template-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .template-panel {
                width: 350px;
                right: 10px;
            }
            body {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .point-item {
                flex-direction: column;
                align-items: stretch;
            }
            .point-item input, .point-item button {
                width: 100%;
            }
            .template-panel {
                width: 90%;
                right: 5%;
                left: 5%;
            }
            .template-buttons button {
                min-width: 100%;
            }
            .template-select-row {
                flex-direction: column;
            }
            .export-buttons button {
                min-width: 100%;
            }
            h2 {
                font-size: 1.3em;
            }
        }
        
        /* è§¦æ‘¸ä¼˜åŒ– */
        button:active {
            opacity: 0.8;
            transform: scale(0.98);
            transition: all 0.1s;
        }
        
        /* å®‰è£…æç¤º */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            cursor: pointer;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .loading.active {
            display: flex;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é¡µè„šæ ·å¼ */
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }
        footer a {
            color: #4285f4;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }
        footer a:hover {
            color: #0d47a1;
            text-decoration: underline;
        }
        footer .footer-text {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- å®‰è£…æç¤º -->
    <div class="install-prompt" id="installPrompt" onclick="installApp()">
        ğŸ“± æ·»åŠ åˆ°æ¡Œé¢ä½¿ç”¨æ›´ä¾¿æ·
    </div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- æ¨¡æ¿é¢æ¿ -->
    <div class="template-panel collapsed">
        <div class="template-header" onclick="toggleTemplatePanel()">
            <h3>æ¨¡æ¿åº“</h3>
        </div>
        <div class="template-content">
            <div class="template-group">
                <h4>ä¸»è½´æ¨¡æ¿</h4>
                <div class="template-buttons">
                    <button onclick="loadTemplate('ä¸»è½´24', true)">ä¸»è½´24</button>
                    <button onclick="loadTemplate('ä¸»è½´26.3', true)">ä¸»è½´26.3</button>
                    <button onclick="loadTemplate('ä¸»è½´27.7', true)">ä¸»è½´27.7</button>
                    <button onclick="loadTemplate('ä¸»è½´28.7', true)">ä¸»è½´28.7</button>
                    <button onclick="loadTemplate('ä¸»è½´33', true)">ä¸»è½´33</button>
                    <button onclick="loadTemplate('ä¸»è½´37.2', true)">ä¸»è½´37.2</button>
                    <button onclick="loadTemplate('ç‰¹åˆ«ç‰ˆ28.7', true)">ç‰¹åˆ«ç‰ˆ28.7</button>
                    <button onclick="loadTemplate('ç‰¹åˆ«ç‰ˆ33', true)">ç‰¹åˆ«ç‰ˆ33</button>
                </div>
            </div>
            
            <div class="template-group">
                <h4>ä¸‹è½´æ¨¡æ¿</h4>
                <div class="template-buttons">
                    <button onclick="loadTemplate('ä¸‹è½´24', true)">ä¸‹è½´24</button>
                    <button onclick="loadTemplate('ä¸‹è½´26.3', true)">ä¸‹è½´26.3</button>
                    <button onclick="loadTemplate('ä¸‹è½´27.7', true)">ä¸‹è½´27.7</button>
                    <button onclick="loadTemplate('ä¸‹è½´28.7', true)">ä¸‹è½´28.7</button>
                    <button onclick="loadTemplate('ä¸‹è½´33', true)">ä¸‹è½´33</button>
                    <button onclick="loadTemplate('ä¸‹è½´ç‰¹åˆ«ç‰ˆ33', true)">ä¸‹è½´ç‰¹åˆ«ç‰ˆ33</button>
                </div>
            </div>
            
            <div class="template-group">
                <h4>é™„åŠ æ¨¡æ¿</h4>
                <div class="template-buttons">
                    <button onclick="loadTemplate('120410å®šä½å­”', false)">120410å®šä½å­”</button>
                    <button onclick="loadTemplate('111810æ’æ°”å­”', false)">111810æ’æ°”å­”</button>
                    <button onclick="loadTemplate('111810æ²‰å­”', false)">111810æ²‰å­”</button>
                    <button onclick="loadTemplate('339810æ²‰å­”', false)">339810æ²‰å­”</button>
                    <button onclick="loadTemplate('339810æ²‰å­”2', false)">339810æ²‰å­”2</button>
                    <button onclick="showMoreTemplates()" class="btn-purple">æ›´å¤šæ¨¡æ¿...</button>
                </div>
            </div>
            
            <div class="template-group">
                <h4>å¤šæ¨¡æ¿ç»„åˆ</h4>
                <div class="multi-template-combination">
                    <div class="template-select-row">
                        <select id="template-select">
                            <option value="">é€‰æ‹©æ¨¡æ¿æ·»åŠ åˆ°ç»„åˆ</option>
                            <!-- ä¸»è½´æ¨¡æ¿ -->
                            <optgroup label="ä¸»è½´æ¨¡æ¿">
                                <option value="ä¸»è½´24">ä¸»è½´24</option>
                                <option value="ä¸»è½´26.3">ä¸»è½´26.3</option>
                                <option value="ä¸»è½´27.7">ä¸»è½´27.7</option>
                                <option value="ä¸»è½´28.7">ä¸»è½´28.7</option>
                                <option value="ä¸»è½´33">ä¸»è½´33</option>
                                <option value="ä¸»è½´37.2">ä¸»è½´37.2</option>
                                <option value="ç‰¹åˆ«ç‰ˆ28.7">ç‰¹åˆ«ç‰ˆ28.7</option>
                                <option value="ç‰¹åˆ«ç‰ˆ33">ç‰¹åˆ«ç‰ˆ33</option>
                            </optgroup>
                            <!-- ä¸‹è½´æ¨¡æ¿ -->
                            <optgroup label="ä¸‹è½´æ¨¡æ¿">
                                <option value="ä¸‹è½´24">ä¸‹è½´24</option>
                                <option value="ä¸‹è½´26.3">ä¸‹è½´26.3</option>
                                <option value="ä¸‹è½´27.7">ä¸‹è½´27.7</option>
                                <option value="ä¸‹è½´28.7">ä¸‹è½´28.7</option>
                                <option value="ä¸‹è½´33">ä¸‹è½´33</option>
                                <option value="ä¸‹è½´ç‰¹åˆ«ç‰ˆ33">ä¸‹è½´ç‰¹åˆ«ç‰ˆ33</option>
                            </optgroup>
                            <!-- é™„åŠ æ¨¡æ¿ -->
                            <optgroup label="é™„åŠ æ¨¡æ¿">
                                <option value="120410å®šä½å­”">120410å®šä½å­”</option>
                                <option value="111810æ’æ°”å­”">111810æ’æ°”å­”</option>
                                <option value="111810æ²‰å­”">111810æ²‰å­”</option>
                                <option value="339810æ²‰å­”">339810æ²‰å­”</option>
                                <option value="339810æ²‰å­”2">339810æ²‰å­”2</option>
                            </optgroup>
                        </select>
                        <button onclick="addTemplateToCombination()" class="btn-green">æ·»åŠ </button>
                    </div>
                    
                    <div class="selected-templates" id="selected-templates">
                        <div style="text-align: center; color: #999; padding: 10px;">
                            æš‚æ— é€‰æ‹©çš„æ¨¡æ¿
                        </div>
                    </div>
                    
                    <div class="template-actions">
                        <button onclick="loadMultiTemplateCombination()" class="btn-purple">åº”ç”¨ç»„åˆæ¨¡æ¿</button>
                        <button onclick="clearTemplateCombination()" class="btn-red">æ¸…ç©ºç»„åˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="calculator">
        <h2>äº”å­”è®¡ç®—å™¨</h2>
        
        <div class="toggle-container">
            <button id="toggleCanvasBtn" onclick="toggleCanvas()" class="toggle-btn btn-green">éšè—å›¾å½¢</button>
            <button onclick="reversePoints()" class="toggle-btn">åè½¬é¡ºåº</button>
            <button onclick="toggleTemplatePanel()" class="toggle-btn btn-purple">æ¨¡æ¿åº“</button>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <label>åœ†å¿ƒ (å›ºå®šç‚¹):</label>
                <div>(0, 0)</div>
            </div>
            
            <div class="input-group">
                <label for="startX">èµ·ç‚¹ X:</label>
                <input type="number" id="startX" placeholder="Xåæ ‡" step="0.1" value="0">
                <label for="startY">èµ·ç‚¹ Y:</label>
                <input type="number" id="startY" placeholder="Yåæ ‡" step="0.1" value="-35">
                <button onclick="updateStartPoint()" class="btn-green">æ›´æ–°èµ·ç‚¹</button>
            </div>
            
            <div class="input-group">
                <label>æ·»åŠ è·¯å¾„ç‚¹ï¼š</label>
                <input type="number" id="newX" placeholder="Xåæ ‡" step="0.1">
                <input type="number" id="newY" placeholder="Yåæ ‡" step="0.1">
                <button onclick="addPoint()">æ·»åŠ ç‚¹</button>
                <button onclick="clearAll()" class="btn-red">æ¸…ç©ºæ‰€æœ‰ç‚¹</button>
            </div>
        </div>
        
        <div id="points-container"></div>
        
        <div class="export-buttons">
            <button onclick="exportAsImage()">å¯¼å‡ºä¸ºå›¾ç‰‡</button>
            <button onclick="exportAsCSV()">å¯¼å‡ºä¸ºCSVè¡¨æ ¼</button>
            <button onclick="exportAsHTML()">å¯¼å‡ºä¸ºHTMLè¡¨æ ¼</button>
        </div>
        
        <div id="results">
            <h3>è®¡ç®—ç»“æœï¼š</h3>
            <table id="result-table">
                <thead>
                    <tr>
                        <th>æ‰‡å½¢</th>
                        <th>èµ·ç‚¹åæ ‡</th>
                        <th>ç»ˆç‚¹åæ ‡</th>
                        <th>åœ†å¿ƒåˆ°ç‚¹è·ç¦»</th>
                        <th>è§’åº¦(Â°)</th>
                        <th>ç›´å¾„</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- ä¸»ç”»å¸ƒ -->
        <canvas id="diagram"></canvas>
    </div>

    <script>
        // å…¨å±€æ•°æ®
        const O = { x: 0, y: 0 }; // åœ†å¿ƒï¼ˆå›ºå®šç‚¹ï¼‰
        let A = { x: 0, y: -35 }; // èµ·ç‚¹ï¼ˆå¯ä¿®æ”¹ï¼‰
        let points = []; // å­˜å‚¨æ‰€æœ‰è·¯å¾„ç‚¹
        let canvasVisible = true;
        let dragItem = null;
        let product = Math.abs(A.y) * 2; // ç§¯æ•° = èµ·ç‚¹Yçš„ç»å¯¹å€¼Ã—2
        let isCombinationMode = false; // æ˜¯å¦ç»„åˆæ¨¡å¼
        let selectedTemplates = []; // å­˜å‚¨é€‰æ‹©çš„æ¨¡æ¿
        let deferredPrompt = null; // PWAå®‰è£…æç¤º
        
        // æ¨¡æ¿æ•°æ®
        const templates = {
            // ä¸»è½´æ¨¡æ¿
            'ä¸»è½´24': {
                points: [
                    { x: 24, y: -8.7 },
                    { x: 16.6, y: 19.3 },
                    { x: 4, y: 19.3 },
                    { x: -18.3, y: 17.8 },
                    { x: -24, y: -8.7 }
                ],
                origin: { x: 0, y: -25.5 }
            },
            'ä¸»è½´26.3': {
                points: [
                    { x: 26.3, y: -9.6 },
                    { x: 18.2, y: 21.4 },
                    { x: -20.1, y: 19.4 },
                    { x: -26.3, y: -9.6 }
                ],
                origin: { x: 0, y: -28 }
            },
            'ä¸»è½´27.7': {
                points: [
                    { x: 27.7, y: -10.2 },
                    { x: 19, y: 22.6 },
                    { x: 3.8, y: 21 },
                    { x: -21.5, y: 20.2 },
                    { x: -27.7, y: -10.2 }
                ],
                origin: { x: 0, y: -29.5 }
            },
            'ä¸»è½´28.7': {
                points: [
                    { x: 28.7, y: -10.4 },
                    { x: 19.6, y: 23.4 },
                    { x: 4.6, y: 22.8 },
                    { x: -21.9, y: 21.2 },
                    { x: -28.7, y: -10.4 }
                ],
                origin: { x: 0, y: -30.5 }
            },
            'ä¸»è½´33': {
                points: [
                    { x: 33, y: -11 },
                    { x: 22, y: 27 },
                    { x: 4.8, y: 22.9 },
                    { x: -24.4, y: 25.1 },
                    { x: -33, y: -11 }
                ],
                origin: { x: 0, y: -35 }
            },
            'ä¸»è½´37.2': {
                points: [
                    { x: 37.2, y: -11.9 },
                    { x: 24.4, y: 30.4 },
                    { x: 4.8, y: 26.3 },
                    { x: -27.6, y: 27.6 },
                    { x: -37.2, y: -11.9 }
                ],
                origin: { x: 0, y: -39 }
            },
            'ç‰¹åˆ«ç‰ˆ28.7': {
                points: [
                    { x: 16.1, y: -25.4 },
                    { x: 28.7, y: -10.4 },
                    { x: 21.2, y: 21.9 },
                    { x: -4.6, y: 22.8 },
                    { x: -19.6, y: 23.4 },
                    { x: -28.7, y: -10.4 },
                    { x: -16.1, y: -25.4 }
                ],
                origin: { x: 0, y: -30.5 }
            },
            'ç‰¹åˆ«ç‰ˆ33': {
                points: [
                    { x: 19, y: -27.7 },
                    { x: 33, y: -11 },
                    { x: 22, y: 27 },
                    { x: 4.6, y: 24.5 },
                    { x: -24.4, y: 25.1 },
                    { x: -33, y: -11 },
                    { x: -19, y: -27.7 }
                ],
                origin: { x: 0, y: -35 }
            },
            
            // ä¸‹è½´æ¨¡æ¿
            'ä¸‹è½´24': {
                points: [
                    { x: 24, y: -8.7 },
                    { x: 18.7, y: 17.8 },
                    { x: -16.6, y: 19.3 },
                    { x: -24, y: -8.7 }
                ],
                origin: { x: 0, y: -25.5 }
            },
            'ä¸‹è½´26.3': {
                points: [
                    { x: 26.3, y: -9.6 },
                    { x: 20.1, y: 19.4 },
                    { x: -4, y: 18.6 },
                    { x: -18, y: 21.4 },
                    { x: -26.3, y: 9.6 }
                ],
                origin: { x: 0, y: -28 }
            },
            'ä¸‹è½´27.7': {
                points: [
                    { x: 27.7, y: -10.2 },
                    { x: 21.5, y: 20.2 },
                    { x: -3.8, y: 21 },
                    { x: -19, y: 22.6 },
                    { x: -27.7, y: -10.2 }
                ],
                origin: { x: 0, y: -29.5 }
            },
            'ä¸‹è½´28.7': {
                points: [
                    { x: 28.7, y: -10.4 },
                    { x: 21.2, y: 21.9 },
                    { x: -4.6, y: 22.8 },
                    { x: -19.6, y: 23.4 },
                    { x: -28.7, y: -10.4 }
                ],
                origin: { x: 0, y: -30.5 }
            },
            'ä¸‹è½´33': {
                points: [
                    { x: 33, y: -11 },
                    { x: 24, y: 25.3 },
                    { x: -4.6, y: 25.9 },
                    { x: -22, y: 27 },
                    { x: -33, y: -11 }
                ],
                origin: { x: 0, y: -35 }
            },
            'ä¸‹è½´ç‰¹åˆ«ç‰ˆ33': {
                points: [
                    { x: 19, y: -27.7 },
                    { x: 33, y: -11 },
                    { x: 24.4, y: 25.1 },
                    { x: -4.6, y: 24.5 },
                    { x: -22, y: 27 },
                    { x: -33, y: -11 },
                    { x: -19, y: -27.7 }
                ],
                origin: { x: 0, y: -35 }
            },
            
            // é™„åŠ æ¨¡æ¿
            '120410å®šä½å­”': { points: [{ x: -35, y: 0 }], origin: null },
            '111810æ’æ°”å­”': { points: [{ x: 18.6, y: -18.7 }, { x: -15.3, y: -21.2 }], origin: null },
            '111810æ²‰å­”': { points: [{ x: 23.5, y: 8.6 }, { x: -20.4, y: -14.4 }], origin: null },
            '339810æ²‰å­”': { points: [{ x: 17.4, y: -25.3 }, { x: -17.4, y: -25.3 }], origin: null },
            '339810æ²‰å­”2': { points: [{ x: 32, y: 14.2 }, { x: -28, y: -20.9 }], origin: null }
        };

        // ==== PWAåŠŸèƒ½ ====
        // ç›‘å¬å®‰è£…æç¤º
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        // æ˜¾ç¤ºå®‰è£…æç¤º
        function showInstallPrompt() {
            if (deferredPrompt && !isAppInstalled()) {
                setTimeout(() => {
                    document.getElementById('installPrompt').style.display = 'block';
                }, 3000);
            }
        }

        // å®‰è£…åº”ç”¨
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ç”¨æˆ·åŒæ„å®‰è£…');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                });
            }
        }

        // æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        // éšè—å®‰è£…æç¤º
        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        // ==== åŸæœ‰åŠŸèƒ½ ====
        // åˆ‡æ¢æ¨¡æ¿é¢æ¿æ˜¾ç¤º/éšè—
        function toggleTemplatePanel() {
            const panel = document.querySelector('.template-panel');
            panel.classList.toggle('collapsed');
        }
        
        // åŠ è½½æ¨¡æ¿
        function loadTemplate(templateName, replaceOrigin) {
            if (templates[templateName]) {
                const template = templates[templateName];
                
                // é‡ç½®ç»„åˆæ¨¡å¼
                isCombinationMode = false;
                selectedTemplates = [];
                updateSelectedTemplatesDisplay();
                
                // å¦‚æœæ˜¯åŸºç¡€æ¨¡æ¿ä¸”éœ€è¦æ›´æ¢åŸç‚¹
                if (replaceOrigin && template.origin) {
                    // æ›´æ¢èµ·ç‚¹
                    A.x = template.origin.x;
                    A.y = template.origin.y;
                    document.getElementById('startX').value = A.x;
                    document.getElementById('startY').value = A.y;
                    product = Math.abs(A.y) * 2; // æ›´æ–°ç§¯æ•°
                    
                    // æ›´æ¢è·¯å¾„ç‚¹
                    points = [...template.points];
                } else {
                    // åªæ·»åŠ è·¯å¾„ç‚¹ï¼Œä¸æ›´æ¢èµ·ç‚¹
                    points = [...template.points];
                }
                
                updatePointsDisplay();
                calculateAll();
                
                // å…³é—­æ¨¡æ¿é¢æ¿
                document.querySelector('.template-panel').classList.add('collapsed');
            }
        }
        
        // æ·»åŠ æ¨¡æ¿åˆ°ç»„åˆ
        function addTemplateToCombination() {
            const templateSelect = document.getElementById('template-select');
            const templateName = templateSelect.value;
            
            if (!templateName) {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿");
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
            if (selectedTemplates.includes(templateName)) {
                alert("è¯¥æ¨¡æ¿å·²æ·»åŠ åˆ°ç»„åˆä¸­");
                return;
            }
            
            // æ·»åŠ åˆ°ç»„åˆ
            selectedTemplates.push(templateName);
            updateSelectedTemplatesDisplay();
            
            // é‡ç½®é€‰æ‹©
            templateSelect.value = "";
        }
        
        // ä»ç»„åˆä¸­ç§»é™¤æ¨¡æ¿
        function removeTemplateFromCombination(index) {
            selectedTemplates.splice(index, 1);
            updateSelectedTemplatesDisplay();
        }
        
        // æ›´æ–°é€‰æ‹©çš„æ¨¡æ¿æ˜¾ç¤º
        function updateSelectedTemplatesDisplay() {
            const container = document.getElementById('selected-templates');
            
            if (selectedTemplates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">æš‚æ— é€‰æ‹©çš„æ¨¡æ¿</div>';
                return;
            }
            
            let html = '';
            selectedTemplates.forEach((templateName, index) => {
                html += `
                    <div class="selected-template-item">
                        <span>${templateName}</span>
                        <button onclick="removeTemplateFromCombination(${index})" class="btn-red" style="padding: 4px 8px; font-size: 0.8em;">ç§»é™¤</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // æ¸…ç©ºæ¨¡æ¿ç»„åˆ
        function clearTemplateCombination() {
            selectedTemplates = [];
            updateSelectedTemplatesDisplay();
        }
        
        // åŠ è½½å¤šæ¨¡æ¿ç»„åˆ
        function loadMultiTemplateCombination() {
            if (selectedTemplates.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿");
                return;
            }
            
            // è®¾ç½®ç»„åˆæ¨¡å¼
            isCombinationMode = true;
            
            // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ¨¡æ¿çš„èµ·ç‚¹
            let combinedOrigin = { x: 0, y: -35 }; // é»˜è®¤èµ·ç‚¹
            if (templates[selectedTemplates[0]] && templates[selectedTemplates[0]].origin) {
                combinedOrigin = { ...templates[selectedTemplates[0]].origin };
            }
            
            // è®¾ç½®èµ·ç‚¹
            A.x = combinedOrigin.x;
            A.y = combinedOrigin.y;
            document.getElementById('startX').value = A.x;
            document.getElementById('startY').value = A.y;
            product = Math.abs(A.y) * 2; // æ›´æ–°ç§¯æ•°
            
            // åˆå¹¶æ‰€æœ‰æ¨¡æ¿çš„è·¯å¾„ç‚¹
            points = [];
            selectedTemplates.forEach(templateName => {
                if (templates[templateName]) {
                    points = points.concat(templates[templateName].points);
                }
            });
            
            updatePointsDisplay();
            calculateAll();
            
            // å…³é—­æ¨¡æ¿é¢æ¿
            document.querySelector('.template-panel').classList.add('collapsed');
        }
        
        // æ˜¾ç¤ºæ›´å¤šæ¨¡æ¿
        function showMoreTemplates() {
            alert("æ›´å¤šæ¨¡æ¿åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...\nå½“å‰ç‰ˆæœ¬å·²åŒ…å«å¸¸ç”¨æ¨¡æ¿ï¼Œå¦‚éœ€æ›´å¤šæ¨¡æ¿è¯·è”ç³»å¼€å‘äººå‘˜ã€‚");
        }
        
        // åˆå§‹åŒ–ç”»å¸ƒ
        let canvas, ctx;
        
        function initCanvas() {
            // ä¸»ç”»å¸ƒ
            canvas = document.getElementById('diagram');
            ctx = canvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();
        }
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = Math.min(400, window.innerHeight * 0.5);
            
            if (points.length > 0) calculateAll();
        }
        
        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initDragAndDrop() {
            const container = document.getElementById('points-container');
            
            container.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('point-item')) {
                    dragItem = e.target;
                    setTimeout(() => {
                        dragItem.classList.add('dragging');
                    }, 0);
                }
            });
            
            container.addEventListener('dragend', function() {
                if (dragItem) {
                    dragItem.classList.remove('dragging');
                    dragItem = null;
                }
            });
            
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const currentItem = document.querySelector('.dragging');
                if (currentItem && afterElement) {
                    container.insertBefore(currentItem, afterElement);
                }
            });
            
            // æ‹–æ‹½ç»“æŸåæ›´æ–°ç‚¹é¡ºåº
            container.addEventListener('drop', function() {
                updatePointsOrder();
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.point-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // æ›´æ–°ç‚¹é¡ºåº
        function updatePointsOrder() {
            const container = document.getElementById('points-container');
            const newPoints = [];
            container.querySelectorAll('.point-item').forEach(item => {
                const index = parseInt(item.dataset.index);
                newPoints.push(points[index]);
            });
            points = newPoints;
            calculateAll();
        }
        
        // æ›´æ–°èµ·ç‚¹
        function updateStartPoint() {
            const startX = parseFloat(document.getElementById('startX').value);
            const startY = parseFloat(document.getElementById('startY').value);
            
            if (!isNaN(startX)) A.x = startX;
            if (!isNaN(startY)) {
                A.y = startY;
                product = Math.abs(A.y) * 2; // æ›´æ–°ç§¯æ•°
            }
            
            calculateAll();
        }
        
        // æ·»åŠ æ–°ç‚¹
        function addPoint() {
            const x = parseFloat(document.getElementById('newX').value);
            const y = parseFloat(document.getElementById('newY').value);
            
            if (isNaN(x) || isNaN(y)) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆåæ ‡");
                return;
            }
            
            points.push({ x, y });
            updatePointsDisplay();
            calculateAll();
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('newX').value = '';
            document.getElementById('newY').value = '';
        }
        
        // æ›´æ–°ç‚¹åˆ—è¡¨æ˜¾ç¤º
        function updatePointsDisplay() {
            const container = document.getElementById('points-container');
            container.innerHTML = '';
            
            points.forEach((point, index) => {
                const div = document.createElement('div');
                div.className = 'point-item';
                div.dataset.index = index;
                div.draggable = true;
                
                let pointLabel = `ç‚¹ ${index + 1}`;
                if (isCombinationMode) {
                    // ç»„åˆæ¨¡å¼ä¸‹ï¼Œè®¡ç®—å½“å‰ç‚¹å±äºå“ªä¸ªæ¨¡æ¿
                    let templateIndex = 0;
                    let pointCount = 0;
                    
                    for (let i = 0; i < selectedTemplates.length; i++) {
                        const templateName = selectedTemplates[i];
                        const templatePoints = templates[templateName].points;
                        
                        if (index < pointCount + templatePoints.length) {
                            templateIndex = i;
                            break;
                        }
                        pointCount += templatePoints.length;
                    }
                    
                    pointLabel = `ç‚¹ ${templateIndex + 1}-${index - pointCount + 1}`;
                }
                
                div.innerHTML = `
                    <span>${pointLabel}:</span>
                    <input type="number" value="${point.x}" onchange="updatePoint(${index}, 'x', this.value)" step="0.1">
                    <input type="number" value="${point.y}" onchange="updatePoint(${index}, 'y', this.value)" step="0.1">
                    <button onclick="removePoint(${index})" class="btn-red">åˆ é™¤</button>
                `;
                container.appendChild(div);
            });
        }
        
        // æ›´æ–°ç‚¹åæ ‡
        function updatePoint(index, coord, value) {
            const num = parseFloat(value);
            if (!isNaN(num)) {
                points[index][coord] = num;
                calculateAll();
            }
        }
        
        // åˆ é™¤ç‚¹
        function removePoint(index) {
            points.splice(index, 1);
            updatePointsDisplay();
            calculateAll();
        }
        
        // æ¸…ç©ºæ‰€æœ‰ç‚¹
        function clearAll() {
            points = [];
            isCombinationMode = false;
            selectedTemplates = [];
            updateSelectedTemplatesDisplay();
            updatePointsDisplay();
            document.querySelector('#result-table tbody').innerHTML = '';
            clearCanvas();
        }
        
        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        // åˆ‡æ¢ç”»å¸ƒå¯è§æ€§
        function toggleCanvas() {
            canvasVisible = !canvasVisible;
            canvas.style.display = canvasVisible ? 'block' : 'none';
            document.getElementById('toggleCanvasBtn').textContent = 
                canvasVisible ? 'éšè—å›¾å½¢' : 'æ˜¾ç¤ºå›¾å½¢';
            
            if (canvasVisible) {
                resizeCanvas();
            }
        }
        
        // åè½¬ç‚¹é¡ºåº
        function reversePoints() {
            points.reverse();
            updatePointsDisplay();
            calculateAll();
        }
        
        // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´è·ç¦»
        function calculateDistance(point1, point2) {
            const dx = point2.x - point1.x;
            const dy = point2.y - point1.y;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // è®¡ç®—ç›´å¾„ï¼ˆå…ˆè®¡ç®—è·ç¦»ï¼Œç„¶åå››èˆäº”å…¥ä¿ç•™ä¸¤ä½å°æ•°ï¼‰
        function calculateDiameter(distance) {
            // å…¬å¼ï¼šç›´å¾„ = è·ç¦» Ã— 2ï¼Œç„¶åå››èˆäº”å…¥ä¿ç•™ä¸¤ä½å°æ•°
            const rawDiameter = distance * 2;
            // å››èˆäº”å…¥åˆ°å°æ•°ç‚¹åä¸¤ä½
            const roundedDiameter = Math.round(rawDiameter * 100) / 100;
            return roundedDiameter.toFixed(2);
        }
        
        // è®¡ç®—æ‰€æœ‰æ‰‡å½¢è§’åº¦å’Œç›´å¾„
        function calculateAll() {
            if (points.length === 0) {
                clearCanvas();
                return;
            }
            
            const results = [];
            let prevPoint = A;
            
            if (isCombinationMode) {
                // ç»„åˆæ¨¡å¼ï¼šåˆ†åˆ«è®¡ç®—æ¯ä¸ªæ¨¡æ¿çš„æ‰‡å½¢
                let pointCount = 0;
                
                for (let templateIndex = 0; templateIndex < selectedTemplates.length; templateIndex++) {
                    const templateName = selectedTemplates[templateIndex];
                    const templatePoints = templates[templateName].points;
                    
                    let templatePrevPoint = A;
                    
                    // è®¡ç®—å½“å‰æ¨¡æ¿çš„æ‰‡å½¢
                    for (let i = 0; i < templatePoints.length; i++) {
                        const point = templatePoints[i];
                        const angle = calculateSectorAngle(O, templatePrevPoint, point);
                        const distance = calculateDistance(O, point);
                        const diameter = calculateDiameter(distance);
                        
                        results.push({
                            name: `æ‰‡å½¢ ${templateIndex + 1}-${i + 1}`,
                            start: { ...templatePrevPoint },
                            end: { ...point },
                            distance: distance.toFixed(2),
                            angle: angle.toFixed(2),
                            diameter: diameter
                        });
                        
                        templatePrevPoint = point;
                    }
                    
                    // å½“å‰æ¨¡æ¿çš„é—­åˆæ‰‡å½¢
                    const finalAngle = calculateSectorAngle(O, templatePrevPoint, A);
                    const startDistance = calculateDistance(O, A);
                    const finalDiameter = calculateDiameter(startDistance);
                    
                    results.push({
                        name: `æ‰‡å½¢ ${templateIndex + 1}-${templatePoints.length + 1}`,
                        start: { ...templatePrevPoint },
                        end: { ...A },
                        distance: startDistance.toFixed(2),
                        angle: finalAngle.toFixed(2),
                        diameter: finalDiameter
                    });
                    
                    pointCount += templatePoints.length;
                }
                
            } else {
                // æ™®é€šæ¨¡å¼
                const startDistance = calculateDistance(O, A); // åœ†å¿ƒåˆ°èµ·ç‚¹çš„è·ç¦»
                
                // è®¡ç®—æ¯ä¸ªæ‰‡å½¢åŒºåŸŸ
                points.forEach((point, index) => {
                    const angle = calculateSectorAngle(O, prevPoint, point);
                    const distance = calculateDistance(O, point); // åœ†å¿ƒåˆ°å½“å‰ç‚¹çš„è·ç¦»
                    const diameter = calculateDiameter(distance);
                    
                    results.push({
                        name: `æ‰‡å½¢ ${index + 1}`,
                        start: { ...prevPoint },
                        end: { ...point },
                        distance: distance.toFixed(2),
                        angle: angle.toFixed(2),
                        diameter: diameter
                    });
                    
                    prevPoint = point;
                });
                
                // é—­åˆè·¯å¾„ï¼ˆä»æœ€åä¸€ä¸ªç‚¹å›åˆ°èµ·ç‚¹ï¼‰
                const finalAngle = calculateSectorAngle(O, prevPoint, A);
                const finalDiameter = calculateDiameter(startDistance);
                
                results.push({
                    name: `æ‰‡å½¢ ${points.length + 1}`,
                    start: { ...prevPoint },
                    end: { ...A },
                    distance: startDistance.toFixed(2),
                    angle: finalAngle.toFixed(2),
                    diameter: finalDiameter
                });
            }
            
            updateResultsTable(results);
            if (canvasVisible) drawDiagram(results);
        }
        
        // è®¡ç®—æ‰‡å½¢è§’åº¦
        function calculateSectorAngle(O, A, B) {
            // å‘é‡OA
            const oaX = A.x - O.x;
            const oaY = A.y - O.y;
            
            // å‘é‡OB
            const obX = B.x - O.x;
            const obY = B.y - O.y;
            
            // è®¡ç®—ç‚¹ç§¯
            const dotProduct = oaX * obX + oaY * obY;
            
            // è®¡ç®—æ¨¡é•¿
            const magnitudeOA = Math.sqrt(oaX * oaX + oaY * oaY);
            const magnitudeOB = Math.sqrt(obX * obX + obY * obY);
            
            // è®¡ç®—å¤¹è§’ï¼ˆå¼§åº¦ï¼‰
            const cosTheta = dotProduct / (magnitudeOA * magnitudeOB);
            const angleRad = Math.acos(Math.min(Math.max(cosTheta, -1), 1));
            
            // è½¬ä¸ºè§’åº¦
            return angleRad * 180 / Math.PI;
        }
        
        // æ›´æ–°ç»“æœè¡¨æ ¼
        function updateResultsTable(results) {
            const tbody = document.querySelector('#result-table tbody');
            tbody.innerHTML = '';
            
            results.forEach(result => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${result.name}</td>
                    <td>(${result.start.x.toFixed(2)}, ${result.start.y.toFixed(2)})</td>
                    <td>(${result.end.x.toFixed(2)}, ${result.end.y.toFixed(2)})</td>
                    <td>${result.distance}</td>
                    <td>${result.angle}</td>
                    <td>${result.diameter}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // ç»˜åˆ¶å›¾å½¢ï¼ˆæ— å¡«å……æ‰‡å½¢ï¼‰
        function drawDiagram(results) {
            clearCanvas();
            
            const allPoints = [O, A, ...points];
            const { scale, offsetX, offsetY } = calculateViewport(allPoints);
            
            const toCanvas = (x, y) => ({
                x: x * scale + offsetX,
                y: canvas.height - (y * scale + offsetY)
            });
            
            drawAxes(scale, offsetX, offsetY);
            
            // ç»˜åˆ¶æ‰‡å½¢åŒºåŸŸï¼ˆæ— å¡«å……ï¼Œåªæœ‰è¾¹æ¡†ï¼‰
            results.forEach((result, index) => {
                const start = result.start;
                const end = result.end;
                
                const oCanvas = toCanvas(O.x, O.y);
                const startCanvas = toCanvas(start.x, start.y);
                const endCanvas = toCanvas(end.x, end.y);
                
                // ç»˜åˆ¶æ‰‡å½¢è¾¹æ¡†
                ctx.beginPath();
                ctx.moveTo(oCanvas.x, oCanvas.y);
                ctx.lineTo(startCanvas.x, startCanvas.y);
                
                // è®¡ç®—åŠå¾„
                const radius = Math.sqrt((startCanvas.x-oCanvas.x)**2 + (startCanvas.y-oCanvas.y)**2);
                
                // è®¡ç®—èµ·å§‹è§’åº¦å’Œç»“æŸè§’åº¦
                const startAngle = Math.atan2(startCanvas.y-oCanvas.y, startCanvas.x-oCanvas.x);
                const endAngle = Math.atan2(endCanvas.y-oCanvas.y, endCanvas.x-oCanvas.x);
                
                // ç»˜åˆ¶åœ†å¼§
                ctx.arc(oCanvas.x, oCanvas.y, radius, startAngle, endAngle);
                ctx.lineTo(oCanvas.x, oCanvas.y);
                
                // åªç»˜åˆ¶è¾¹æ¡†ï¼Œä¸å¡«å……
                ctx.strokeStyle = `hsl(${index * 60 % 360}, 80%, 50%)`;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // æ ‡æ³¨è§’åº¦
                const midAngle = (startAngle + endAngle) / 2;
                const labelRadius = radius * 0.5;
                ctx.fillStyle = '#000';
                ctx.font = '12px Arial';
                ctx.fillText(
                    `${result.angle}Â°`,
                    oCanvas.x + Math.cos(midAngle) * labelRadius,
                    oCanvas.y + Math.sin(midAngle) * labelRadius
                );
            });
            
            // ç»˜åˆ¶æ‰€æœ‰ç‚¹
            function drawPoint(x, y, label, color, size = 4) {
                const p = toCanvas(x, y);
                ctx.beginPath();
                ctx.arc(p.x, p.y, size, 0, Math.PI*2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.font = '10px Arial';
                ctx.fillText(label, p.x + 8, p.y - 8);
            }
            
            drawPoint(O.x, O.y, "åœ†å¿ƒ (0,0)", '#0f9d58', 5);
            drawPoint(A.x, A.y, `èµ·ç‚¹ (${A.x},${A.y})`, '#ea4335', 5);
            
            points.forEach((point, index) => {
                let pointLabel = `ç‚¹${index+1}`;
                if (isCombinationMode) {
                    // ç»„åˆæ¨¡å¼ä¸‹ï¼Œè®¡ç®—å½“å‰ç‚¹å±äºå“ªä¸ªæ¨¡æ¿
                    let templateIndex = 0;
                    let pointCount = 0;
                    
                    for (let i = 0; i < selectedTemplates.length; i++) {
                        const templateName = selectedTemplates[i];
                        const templatePoints = templates[templateName].points;
                        
                        if (index < pointCount + templatePoints.length) {
                            templateIndex = i;
                            break;
                        }
                        pointCount += templatePoints.length;
                    }
                    
                    pointLabel = `ç‚¹${templateIndex + 1}-${index - pointCount + 1}`;
                }
                drawPoint(point.x, point.y, `${pointLabel} (${point.x},${point.y})`, '#4285f4', 4);
            });
        }
        
        // ç»˜åˆ¶åæ ‡è½´
        function drawAxes(scale, offsetX, offsetY) {
            ctx.beginPath();
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            const xAxisY = canvas.height - (0 * scale + offsetY);
            ctx.moveTo(0, xAxisY);
            ctx.lineTo(canvas.width, xAxisY);
            
            const yAxisX = 0 * scale + offsetX;
            ctx.moveTo(yAxisX, 0);
            ctx.lineTo(yAxisX, canvas.height);
            
            ctx.stroke();
        }
        
        // è®¡ç®—è§†å›¾å‚æ•°
        function calculateViewport(points) {
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;
            
            points.forEach(point => {
                minX = Math.min(minX, point.x);
                maxX = Math.max(maxX, point.x);
                minY = Math.min(minY, point.y);
                maxY = Math.max(maxY, point.y);
            });
            
            const widthRange = Math.max(maxX - minX, 20);
            const heightRange = Math.max(maxY - minY, 20);
            const padding = 40;
            
            const scale = Math.min(
                (canvas.width - padding * 2) / widthRange,
                (canvas.height - padding * 2) / heightRange
            );
            
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;
            
            const offsetX = canvas.width / 2 - centerX * scale;
            const offsetY = canvas.height / 2 - centerY * scale;
            
            return { scale, offsetX, offsetY };
        }
        
        // å¯¼å‡ºåŠŸèƒ½
        function exportAsImage() {
            showLoading(true);
            setTimeout(() => {
                try {
                    // åˆ›å»ºæ–°canvasåªåŒ…å«è¡¨æ ¼
                    const exportCanvas = document.createElement('canvas');
                    const exportCtx = exportCanvas.getContext('2d');
                    const table = document.getElementById('result-table');
                    
                    exportCanvas.width = Math.max(800, table.offsetWidth);
                    exportCanvas.height = table.offsetHeight + 100;
                    
                    // ç™½è‰²èƒŒæ™¯
                    exportCtx.fillStyle = 'white';
                    exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
                    
                    // æ·»åŠ æ ‡é¢˜
                    exportCtx.fillStyle = 'black';
                    exportCtx.font = 'bold 20px Arial';
                    exportCtx.fillText('äº”å­”è®¡ç®—ç»“æœ', 20, 40);
                    
                    // ç»˜åˆ¶è¡¨æ ¼
                    exportCtx.font = '12px Arial';
                    let yPos = 80;
                    
                    // è¡¨å¤´
                    const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
                    exportCtx.fillStyle = '#f2f2f2';
                    exportCtx.fillRect(20, yPos, exportCanvas.width - 40, 30);
                    exportCtx.fillStyle = 'black';
                    headers.forEach((header, i) => {
                        exportCtx.fillText(header, 25 + i * 130, yPos + 20);
                    });
                    yPos += 30;
                    
                    // è¡¨æ ¼å†…å®¹
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach((row, rowIndex) => {
                        const cells = row.querySelectorAll('td');
                        cells.forEach((cell, cellIndex) => {
                            exportCtx.fillText(cell.textContent, 25 + cellIndex * 130, yPos + 20);
                        });
                        yPos += 30;
                        
                        // äº¤æ›¿è¡ŒèƒŒæ™¯è‰²
                        if (rowIndex % 2 === 0) {
                            exportCtx.fillStyle = 'rgba(0,0,0,0.05)';
                            exportCtx.fillRect(20, yPos - 25, exportCanvas.width - 40, 30);
                            exportCtx.fillStyle = 'black';
                        }
                    });
                    
                    // è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
                    const dataURL = exportCanvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'äº”å­”è®¡ç®—ç»“æœ.png';
                    link.href = dataURL;
                    link.click();
                } catch (error) {
                    alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼š' + error.message);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }
        
        function exportAsCSV() {
            showLoading(true);
            setTimeout(() => {
                try {
                    let csvContent = "æ‰‡å½¢,èµ·ç‚¹åæ ‡,ç»ˆç‚¹åæ ‡,åœ†å¿ƒåˆ°ç‚¹è·ç¦»,è§’åº¦(Â°),ç›´å¾„\n";
                    
                    const rows = document.querySelectorAll('#result-table tbody tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        const rowData = Array.from(cells).map(cell => cell.textContent.replace(/,/g, ';'));
                        csvContent += rowData.join(',') + '\n';
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.download = 'äº”å­”è®¡ç®—ç»“æœ.csv';
                    link.href = URL.createObjectURL(blob);
                    link.click();
                } catch (error) {
                    alert('å¯¼å‡ºCSVå¤±è´¥ï¼š' + error.message);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }
        
        function exportAsHTML() {
            showLoading(true);
            setTimeout(() => {
                try {
                    const table = document.getElementById('result-table').outerHTML;
                    
                    const htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>äº”å­”è®¡ç®—ç»“æœ</title>
                            <style>
                                body { font-family: Arial; margin: 20px; }
                                table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f2f2f2; }
                                h1 { color: #4285f4; }
                            </style>
                        </head>
                        <body>
                            <h1>äº”å­”è®¡ç®—ç»“æœ</h1>
                            ${table}
                            <p>å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>
                        </body>
                        </html>
                    `;
                    
                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.download = 'äº”å­”è®¡ç®—ç»“æœ.html';
                    link.href = URL.createObjectURL(blob);
                    link.click();
                } catch (error) {
                    alert('å¯¼å‡ºHTMLå¤±è´¥ï¼š' + error.message);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }
        
        // åˆå§‹åŒ–
        window.onload = function() {
            initCanvas();
            
            // åŠ è½½é»˜è®¤æ¨¡æ¿
            loadTemplate('ä¸»è½´33', true);
            
            // æ£€æŸ¥æ˜¯å¦å·²å®‰è£…PWA
            if (isAppInstalled()) {
                console.log('åº”ç”¨å·²å®‰è£…åˆ°æ¡Œé¢');
            }
            
            // 5ç§’åæ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºå®‰è£…æç¤º
            setTimeout(() => {
                showInstallPrompt();
            }, 5000);
        };
    </script>
    
    <!-- GitHubä»“åº“é“¾æ¥ -->
    <footer>
        <p>
            <a href="https://github.com/Xiaowuyu273637/Five-hole-calculator" 
               target="_blank">
                ğŸŒŸ GitHubä»“åº“: https://github.com/Xiaowuyu273637/Five-hole-calculator
            </a>
        </p>
        <p class="footer-text">
            äº”å­”è®¡ç®—å™¨ - ä¸“ä¸šçš„äº”å­”è®¡ç®—å·¥å…·
        </p>
    </footer>
</body>
</html>